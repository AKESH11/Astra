<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTRA - Conversational SIEM Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0e17;
        }
        .scrollbar-hidden::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hidden {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .astra-glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4), 0 0 8px rgba(59, 130, 246, 0.3);
        }
        .message-bubble-user {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
        }
        .message-bubble-astra {
            background-color: #1e293b;
        }
        .loader {
            border: 4px solid #303a4c;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [messages, setMessages] = useState([
                { 
                    id: 1, 
                    sender: 'astra', 
                    text: "Welcome to ASTRA. I am your AI Security Assistant for threat investigation and reporting. How can I help you today?",
                    summary: null,
                    logs: null,
                    report_link: null,
                }
            ]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages, isLoading]);

            const handleSendMessage = async () => {
                if (input.trim() === '' || isLoading) return;

                const userMessage = { id: Date.now(), sender: 'user', text: input };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsLoading(true);

                try {
                    // REAL API CALL to the backend gateway
                    const response = await fetch('http://localhost:8000/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: input, user_id: 'analyst1' })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Network response was not ok');
                    }
                    
                    const data = await response.json();
                    
                    // The backend now returns a fully formed message object
                    const astraMessage = {
                        id: Date.now() + 1,
                        sender: 'astra',
                        ...data // Spread the data from the API response
                    };

                    setMessages(prev => [...prev, astraMessage]);

                } catch (error) {
                    console.error("API Error:", error);
                    const errorMessage = { id: Date.now() + 1, sender: 'astra', text: `Sorry, an error occurred: ${error.message}` };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };

            const Message = ({ msg }) => {
                const isUser = msg.sender === 'user';
                return (
                    <div className={`flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`}>
                        <div className={`max-w-xl px-4 py-3 rounded-2xl ${isUser ? 'message-bubble-user text-white' : 'message-bubble-astra text-slate-200'}`}>
                            <p className="text-md">{msg.text}</p>
                            {msg.summary && (
                                <div className="mt-3 p-3 bg-slate-800/50 rounded-lg border border-slate-600">
                                    <h4 className="font-semibold text-blue-400 mb-1 flex items-center"><i className="fas fa-file-alt mr-2"></i>AI Summary & Narrative</h4>
                                    <p className="text-sm text-slate-300 font-mono">{msg.summary}</p>
                                </div>
                            )}
                            {msg.logs && (
                                <div className="mt-3 p-3 bg-slate-800/50 rounded-lg border border-slate-600">
                                    <h4 className="font-semibold text-blue-400 mb-2 flex items-center"><i className="fas fa-clipboard-list mr-2"></i>Key Evidence Logs</h4>
                                    <div className="text-xs text-slate-400 font-mono space-y-1">
                                        {msg.logs.map((log, index) => <p key={index}>{`> ${log}`}</p>)}
                                    </div>
                                </div>
                            )}
                            {msg.report_link && (
                                <div className="mt-3">
                                    <a 
                                      href={msg.report_link} 
                                      target="_blank" 
                                      className="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 transition-colors text-white rounded-lg text-sm font-semibold"
                                    >
                                        <i className="fas fa-file-pdf mr-2"></i> Download Incident Report
                                    </a>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex h-screen w-full bg-[#0a0e17] text-white">
                    {/* Sidebar */}
                    <div className="w-1/5 bg-[#111827] p-6 flex flex-col justify-between border-r border-slate-700">
                        <div>
                            <div className="flex items-center space-x-3 mb-10">
                                <div className="p-3 bg-blue-500/20 rounded-lg astra-glow">
                                    <i className="fas fa-shield-halved text-blue-400 text-2xl"></i>
                                </div>
                                <h1 className="text-2xl font-bold text-slate-100">ASTRA</h1>
                            </div>
                            <h2 className="text-slate-400 text-sm mb-4">Proactive Hunting</h2>
                            <div className="space-y-3">
                                <button onClick={() => setInput("Initiate 'Ransomware Hunt'")} className="w-full text-left px-4 py-2 rounded-lg bg-slate-700/50 hover:bg-slate-600/70 transition-colors">
                                    <i className="fas fa-virus mr-2 text-red-400"></i>Ransomware Hunt
                                </button>
                                <button onClick={() => setInput("Look for signs of data exfiltration")} className="w-full text-left px-4 py-2 rounded-lg bg-slate-700/50 hover:bg-slate-600/70 transition-colors">
                                    <i className="fas fa-cloud-upload-alt mr-2 text-green-400"></i>Data Exfiltration Hunt
                                </button>
                                <button onClick={() => setInput("Scan for lateral movement activity")} className="w-full text-left px-4 py-2 rounded-lg bg-slate-700/50 hover:bg-slate-600/70 transition-colors">
                                    <i className="fas fa-network-wired mr-2 text-yellow-400"></i>Lateral Movement Hunt
                                </button>
                            </div>
                        </div>
                        <div className="text-center text-xs text-slate-500">
                            <p>ISRO SIH 2025</p>
                            <p>Problem ID: SIH25173</p>
                        </div>
                    </div>

                    {/* Main Chat Area */}
                    <div className="flex-1 flex flex-col">
                        <div id="messages" className="flex-1 p-6 overflow-y-auto scrollbar-hidden">
                            {messages.map(msg => <Message key={msg.id} msg={msg} />)}
                            {isLoading && (
                                <div className="flex justify-start mb-4">
                                     <div className="flex items-center space-x-3 max-w-xl px-4 py-3 rounded-2xl message-bubble-astra text-slate-200">
                                        <div className="loader"></div>
                                        <p className="text-md">ASTRA is thinking...</p>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Input Area */}
                        <div className="p-6">
                            <div className="bg-[#1e293b] rounded-lg p-2 flex items-center border border-slate-700 focus-within:border-blue-500 transition-colors">
                                <input
                                    type="text"
                                    value={input}
                                    onChange={e => setInput(e.target.value)}
                                    onKeyPress={e => e.key === 'Enter' && handleSendMessage()}
                                    className="flex-1 bg-transparent outline-none px-4 text-slate-200 placeholder-slate-500"
                                    placeholder="Ask ASTRA about threats, IPs, users, or generate reports..."
                                    disabled={isLoading}
                                />
                                <button onClick={handleSendMessage} disabled={isLoading} className="bg-blue-600 hover:bg-blue-700 disabled:bg-slate-500 disabled:cursor-not-allowed transition-colors rounded-md px-5 py-2">
                                    <i className="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

